(function(e){"function"===typeof define&&void 0!==define.amd?define(function(){return e}):this.Dialog=e})(function(e){function b(a){this.createPromise();this.initProps();this.create(a);return this.callee}var h=/<script(\s|\S)*?(\s|\S)*?<\/script(\s|\S)*?>/g,k=/<script(\s|\S)*?>|<\/script(\s|\S)*?>/g,m=/(\/\*(\s|\S)*?\*\/)|<!-{2,}(\s|\S)*?-{2,}>|^\/\/.*|(\/\/.*)/g,l=Object.prototype.hasOwnProperty,n=new DOMParser,g=Object.create(null);b.prototype.initProps=function(){this.isDestroy=!1;this.html=this.url=
null;this.scriptFns=[];this.ids=[];this.callee=Object.create(null);this.scope={self:null,state:{}};this.message={on:this.onMessage.bind(this)};this.messageStorage=Object.create(null);this.renderConstructorParam={};this.constructorFn=null;this.constructorOption={};this.destroyFn=null};b.prototype.createPromise=function(){this.Promise=new e};b.prototype.setProps=function(a){for(var d in a)l.call(this,d)&&(this[d]=a[d])};b.prototype.validator=function(a){void 0==a&&this.throwError("syntax",'"option" is required ');
void 0==a.url&&this.throwError("syntax",'option\'s prop is required: "url"');return!0};b.prototype.setConstructor=function(a){var d=this,c;a.some(function(b,f){c=n.parseFromString(b,"text/html").getElementsByTagName("script")[0];if(c.hasAttribute("dialog-type")&&"constructor"===c.getAttribute("dialog-type"))return d.constructorFn=d.makeFn(b.replace(k,"")),a.splice(f,1),!0})};b.prototype.create=function(a){this.validator(a);this.setProps({isDestroy:!1,url:a.url,callee:{create:this.create.bind(this),
render:this.render.bind(this),clear:this.clear.bind(this),postMessage:this.postMessage.bind(this),destroy:this.destroy.bind(this)},constructorOption:a.option?this.copyObject(a.option):{}});var d=this;this.Promise.then("create",function(a){d.getDialog(d.url,function(b){var c=b.replace(m,"");b=c.replace(h,"");c=c.match(h);d.setConstructor(c);c=c.map(function(a,b){return d.makeFn(a.replace(k,""))});d.setProps({html:b,scriptFns:c});a()})});this.Promise.then("runConstructor",function(a){this.constructorFn?
this.constructorFn(null,null,null,this.dialogConstructor.bind(this,a)):a()}.bind(this));return this.callee};b.prototype.dialogConstructor=function(a,d){d(this.setStateToScope.bind(this,a),this.constructorOption)};b.prototype.render=function(a,d){if(!this.isDestroy){var b=this;this.Promise.then("render",function(c){-1===b.ids.indexOf(a)&&b.ids.push(a);d&&(b.renderConstructorParam=d);b.renderHTML(a);b.setSelfToScope(a);b.runScript();c()});return this.callee}};b.prototype.clear=function(a){if(!this.isDestroy){var b=
this;this.Promise.then("clear",function(d){var c=a?[a]:b.ids,f;c.forEach(function(a,b){for(f=document.getElementById(a);f.firstChild;)f.removeChild(f.firstChild)});b.ids=c.filter(function(a,d){return-1===b.ids.indexOf(a)});d()});return this.callee}};b.prototype.destroy=function(){this.Promise.then("destroy",function(a){this.destroyFn.call(this.scope);a()}.bind(this));this.clear();this.initProps();this.isDestroy=!0;return this.callee};b.prototype.renderHTML=function(a){var b=document.getElementById(a);
null==b&&this.throwError("error",'not found element: "'+a+'"');b.innerHTML=this.html};b.prototype.runScript=function(){this.scriptFns.forEach(function(a){a(this.message,this.renderConstructorFn.bind(this),this.renderDestroyFn.bind(this))}.bind(this))};b.prototype.renderConstructorFn=function(a){a.call(this.scope,this.copyObject(this.renderConstructorParam));this.renderConstructorParam=null};b.prototype.renderDestroyFn=function(a){this.destroyFn=a};b.prototype.makeFn=function(a){return Function("message",
"renderConstructor","renderDestroy","dialogConstructor",a)};b.prototype.getDialog=function(a,b){var d=this;if(d.hasCache(a))b(d.getCache(a));else{var e=new XMLHttpRequest;e.open("get",a,!0);e.onload=function(c){200===c.target.status?(d.setCache(a,c.target.responseText),b(c.target.responseText)):d.throwError("error",'Invalid url: "'+a+'" ['+c.target.status+"]")};e.send()}};b.prototype.copyObject=function(a){if("string"===typeof a)var b=a;else{b={};for(var c in a)b[c]=a[c]}return b};b.prototype.setSelfToScope=
function(a){a=document.getElementById(a).querySelector("[dialog-root]");this.scope.parent=a.parentNode;this.scope.self=a;this.callee.self=a};b.prototype.setStateToScope=function(a,b){this.scope.state=b;a()};b.prototype.onMessage=function(a,b){this.messageStorage[a]=b};b.prototype.postMessage=function(a,b){if(!this.isDestroy)return this.Promise.then("postMessege",function(c){void 0===this.messageStorage[a]&&this.throwError("error","not found onMessage: "+a);this.messageStorage[a].call(this.scope,b);
c()}.bind(this)),this.callee};b.prototype.hasCache=function(a){return l.call(g,a)};b.prototype.setCache=function(a,b){return g[a]=b};b.prototype.getCache=function(a){return g[a]};b.prototype.throwError=function(a,b){var c="[Dialog] "+b;switch(a){case "error":throw Error(c);case "syntac":throw new SyntaxError(c);case "type":throw new TypeError(c);case "range":throw new RangeError(c);}};return b}(function(){var e=function(){this.ing=!1;this.queue=[]};e.prototype.then=function(b,e){this.queue.push(e);
this.run()};e.prototype.run=function(b){!this.ing&&0<this.queue.length&&(this.ing=!0,this.queue.shift()(this.makeResolve(),b))};e.prototype.makeResolve=function(){return function(b){this.ing=!1;this.run(b)}.bind(this)};return e}()));