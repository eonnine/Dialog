(function(g){"function"===typeof define&&void 0!==define.$?define(function(){return g}):this.Dialog=g})(function(g){function c(a){this.Z(a);this.K();this.w();this.create(a);return this.focus.bind(this)}var h=/<script(\s|\S)*?(\s|\S)*?<\/script(\s|\S)*?>/g,m=/<script(\s|\S)*?>|<\/script(\s|\S)*?>/g,n=/(\/\*(\s|\S)*?\*\/)|<!-{2,}(\s|\S)*?-{2,}>|^\/\/.*|(\/\/.*)/g,k=Object.prototype.hasOwnProperty,p=new DOMParser,l=Object.create(null);c.prototype.w=function(){this.a=!1;this.id=null;this.url=this.url?
this.url:null;this.v=null;this.F=[];this.callee={create:this.create.bind(this),B:this.B.bind(this),C:this.C.bind(this),clear:this.clear.bind(this),postMessage:this.postMessage.bind(this),c:this.c.bind(this),focus:this.focus.bind(this)};this.scope={self:null,state:{},clear:this.clear.bind(this),c:this.c.bind(this),postMessage:this.postMessage.bind(this)};this.message={aa:this.onMessage.bind(this)};this.m=Object.create(null);this.u={};this.j=this.g=this.s=this.h=null;this.f=[]};c.prototype.K=function(){this.Promise=
new g};c.prototype.G=function(a){for(var b in a)k.call(this,b)&&(this[b]=a[b])};c.prototype.Z=function(a){void 0==a&&this.b("syntax",'"option" is required ');void 0==a.url&&this.b("syntax",'option\'s prop is required: "url"')};c.prototype.V=function(a){var b=this,d;a.some(function(f,e){d=p.parseFromString(f,"text/html").getElementsByTagName("script")[0];if(d.hasAttribute("dialog-type")&&"constructor"===d.getAttribute("dialog-type"))return b.h=b.A(f.replace(m,"")),a.splice(e,1),!0})};c.prototype.create=
function(a){this.G({a:!1,url:this.url?this.url:a.url+".dtnc",u:null!=a&&a.P?this.i(a.P):{}});var b=this;this.Promise.then("create",function(d){b.M(b.url,function(f){var e=f.replace(n,"");f=e.replace(h,"");e=e.match(h);b.V(e);e=e.map(function(q){return b.A(q.replace(m,""))});b.G({v:f,F:e});d()})});this.Promise.then("createHook",function(d){b.S();this.h?this.h(this.I.bind(this,d)):d()}.bind(this));return this.callee};c.prototype.I=function(a,b){b(this.Y.bind(this,a),this.u)};c.prototype.B=function(a){if(!this.a){var b=
this;b.clear();this.Promise.then("render",function(d){b.R();b.H();b.s&&b.s.call(b.scope,b.i(a));d()});return this.callee}};c.prototype.C=function(){if(!this.a)return this.callee};c.prototype.R=function(){var a=document.getElementById(this.id);null==a&&this.b("error",'not found element: "'+this.id+'"');a.innerHTML=this.v};c.prototype.clear=function(){if(!this.a)return this.id&&this.Promise.then("clear",function(a){this.g&&this.g.call(this.scope);this.J(a,this.id)}.bind(this)),this.callee};c.prototype.J=
function(a,b){for(var d=document.getElementById(b);d.firstChild;)d.removeChild(d.firstChild);this.f=this.f.filter(function(f){return-1===f.indexOf(b)});a()};c.prototype.c=function(){this.Promise.then("destroy",function(a){this.j&&this.j.call(this.scope);this.clear();this.w();this.a=!0;a()}.bind(this))};c.prototype.S=function(){this.F.forEach(function(a){a(null,this.message,this.X.bind(this),this.U.bind(this),this.W.bind(this))}.bind(this))};c.prototype.X=function(a){this.s=a};c.prototype.U=function(a){this.g=
a};c.prototype.W=function(a){this.j=a};c.prototype.A=function(a){return Function("Dialog$Create","Dialog$Message","Dialog$Render","Dialog$Clear","Dialog$Destroy",a)};c.prototype.M=function(a,b){var d=this;if(d.N(a))b(d.L(a));else{var f=new XMLHttpRequest;f.open("get",a,!0);f.onload=function(e){200===e.target.status?(d.T(a,e.target.responseText),b(e.target.responseText)):d.b("error",'Invalid url: "'+a+'" ['+e.target.status+"]")};f.send()}};c.prototype.i=function(a){if("string"===typeof a)var b=a;else{b=
{};for(var d in a)b[d]=a[d]}return b};c.prototype.focus=function(a){if(a){var b=this;this.Promise.then("focus",function(d){-1===b.f.indexOf(a)&&b.f.push(a);b.id=a;b.H();d()})}return this.callee};c.prototype.H=function(){var a=document.getElementById(this.id);null==a&&this.b("error",'not found element: id is "'+this.id+'"');this.scope.self=a;this.callee.self=a};c.prototype.Y=function(a,b){this.scope.state=b;a()};c.prototype.onMessage=function(a,b){this.m[a]=b};c.prototype.postMessage=function(a,b){if(!this.a)return this.Promise.then("postMessege",
function(d){k.call(this.m,a)&&this.m[a].call(this.i(this.scope),b);d()}.bind(this)),this.callee};c.prototype.N=function(a){return k.call(l,a)};c.prototype.T=function(a,b){l[a]=b};c.prototype.L=function(a){return l[a]};c.prototype.b=function(a,b){var d="[Dialog] "+b;switch(a){case "error":throw Error(d);case "syntac":throw new SyntaxError(d);case "type":throw new TypeError(d);case "range":throw new RangeError(d);}};return c}(function(){function g(){this.l=!1;this.o=[]}g.prototype.then=function(c,h){this.o.push(h);
this.D()};g.prototype.D=function(c){!this.l&&0<this.o.length&&(this.l=!0,this.o.shift()(this.O(),c))};g.prototype.O=function(){return function(c){this.l=!1;this.D(c)}.bind(this)};return g}()));