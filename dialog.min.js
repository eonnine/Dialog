(function(g){"function"===typeof define&&void 0!==define.aa?define(function(){return g}):this.Dialog=g})(function(g){function c(a){this.$(a);this.P();this.w();this.create(a);return this.focus.bind(this)}var k=/<script(\s|\S)*?(\s|\S)*?<\/script(\s|\S)*?>/g,m=/<script(\s|\S)*?>|<\/script(\s|\S)*?>/g,n=/(\/\*(\s|\S)*?\*\/)|<!-{2,}(\s|\S)*?-{2,}>|^\/\/.*|(\/\/.*)/g,h=Object.prototype.hasOwnProperty,p=new DOMParser,l=Object.create(null);c.prototype.w=function(){this.a=!1;this.id=null;this.url=this.url?
this.url:null;this.v=null;this.H=[];this.h=[];this.callee={create:this.create.bind(this),B:this.B.bind(this),C:this.C.bind(this),clear:this.clear.bind(this),postMessage:this.postMessage.bind(this),u:this.u.bind(this),focus:this.focus.bind(this)};this.scope={self:null,state:{}};this.message={ba:this.onMessage.bind(this)};this.l=Object.create(null);this.o={};this.s={};this.i=null;this.b=Object.create(null);this.f=Object.create(null)};c.prototype.P=function(){this.Promise=new g};c.prototype.I=function(a){for(var b in a)h.call(this,
b)&&(this[b]=a[b])};c.prototype.$=function(a){void 0==a&&this.g("syntax",'"option" is required ');void 0==a.url&&this.g("syntax",'option\'s prop is required: "url"')};c.prototype.Y=function(a){var b=this,d;a.some(function(f,e){d=p.parseFromString(f,"text/html").getElementsByTagName("script")[0];if(d.hasAttribute("dialog-type")&&"constructor"===d.getAttribute("dialog-type"))return b.i=b.A(f.replace(m,"")),a.splice(e,1),!0})};c.prototype.create=function(a){this.I({a:!1,url:this.url?this.url:a.url+".dtnc",
s:null!=a&&a.V?this.c(a.V):{}});var b=this;this.Promise.then("create",function(d){b.S(b.url,function(f){var e=f.replace(n,"");f=e.replace(k,"");e=e.match(k);b.Y(e);e=e.map(function(q){return b.A(q.replace(m,""))});b.I({v:f,H:e});d()})});this.Promise.then("createHook",function(d){this.i?this.i(this.L.bind(this,d)):d()}.bind(this));return this.callee};c.prototype.L=function(a,b){b(this.Z.bind(this,a),this.s)};c.prototype.B=function(a){if(!this.a){var b=this;this.Promise.then("render",function(d){a&&
(b.o=a);b.W();b.J();b.G();d()});return this.callee}};c.prototype.C=function(){if(!this.a){var a=this;this.Promise.then("renderScript",function(b){a.G();b()});return this.callee}};c.prototype.W=function(){var a=document.getElementById(this.id);null==a&&this.g("error",'not found element: "'+this.id+'"');a.innerHTML=this.v};c.prototype.clear=function(){if(!this.a)return this.Promise.then("clear",function(a){h.call(this.b,this.id)&&this.F(this.b);this.O(a,this.id)}.bind(this)),this.callee};c.prototype.O=
function(a,b){for(var d=document.getElementById(b);d.firstChild;)d.removeChild(d.firstChild);this.h=this.h.filter(function(f){return-1===f.indexOf(b)});a()};c.prototype.u=function(){this.Promise.then("destroy",function(a){h.call(this.f,this.id)&&this.F(this.f);a()}.bind(this));this.clear();this.w();this.a=!0};c.prototype.F=function(a){a=a[this.id];if(Array.isArray(a))for(;0<a.length;)a.shift()()};c.prototype.G=function(){this.H.forEach(function(a){a(null,this.message,this.N.bind(this),this.K.bind(this),
this.M.bind(this))}.bind(this))};c.prototype.N=function(a){a.call(this.scope,this.c(this.o));this.o=null};c.prototype.K=function(a){h.call(this.b,this.id)||(this.b[this.id]=[]);this.b[this.id].push(a.bind(this.c(this.scope)))};c.prototype.M=function(a){h.call(this.f,this.id)||(this.f[this.id]=[]);this.f[this.id].push(a.bind(this.c(this.scope)))};c.prototype.A=function(a){return Function("Dialog$Create","Dialog$Message","Dialog$Render","Dialog$Clear","Dialog$Destroy",a)};c.prototype.S=function(a,b){var d=
this;if(d.T(a))b(d.R(a));else{var f=new XMLHttpRequest;f.open("get",a,!0);f.onload=function(e){200===e.target.status?(d.X(a,e.target.responseText),b(e.target.responseText)):d.g("error",'Invalid url: "'+a+'" ['+e.target.status+"]")};f.send()}};c.prototype.c=function(a){if("string"===typeof a)var b=a;else{b={};for(var d in a)b[d]=a[d]}return b};c.prototype.focus=function(a){if(a){var b=this;this.Promise.then("focus",function(d){-1===b.h.indexOf(a)&&b.h.push(a);b.id=a;b.J();d()})}return this.callee};
c.prototype.J=function(){var a=document.getElementById(this.id);null==a&&this.g("error",'not found element: id is "'+this.id+'"');this.scope.self=a;this.callee.self=a};c.prototype.Z=function(a,b){this.scope.state=b;a()};c.prototype.onMessage=function(a,b){this.l[a]=b};c.prototype.postMessage=function(a,b){if(!this.a)return this.Promise.then("postMessege",function(d){h.call(this.l,a)&&this.l[a].call(this.c(this.scope),b);d()}.bind(this)),this.callee};c.prototype.T=function(a){return h.call(l,a)};c.prototype.X=
function(a,b){l[a]=b};c.prototype.R=function(a){return l[a]};c.prototype.g=function(a,b){var d="[Dialog] "+b;switch(a){case "error":throw Error(d);case "syntac":throw new SyntaxError(d);case "type":throw new TypeError(d);case "range":throw new RangeError(d);}};return c}(function(){function g(){this.j=!1;this.m=[]}g.prototype.then=function(c,k){this.m.push(k);this.D()};g.prototype.D=function(c){!this.j&&0<this.m.length&&(this.j=!0,this.m.shift()(this.U(),c))};g.prototype.U=function(){return function(c){this.j=
!1;this.D(c)}.bind(this)};return g}()));