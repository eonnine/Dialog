(function(c){"function"===typeof define&&void 0!==define.amd?define(function(){return c}):this.Dialog=c})(function(c){function b(a){this.initProps();this.create(a);return this.callee}var g=/<script(\s|\S)*?(\s|\S)*?<\/script(\s|\S)*?>/g,h=/<script(\s|\S)*?>|<\/script(\s|\S)*?>/g,k=Object.prototype.hasOwnProperty,l=new DOMParser,f=Object.create(null);b.prototype.initProps=function(){this.isDestroy=!1;this.html=this.url=null;this.scriptFns=[];this.ids=[];this.callee=Object.create(null);this.scope={self:null,
state:{}};this.message={on:this.onMessage.bind(this)};this.messageStorage=Object.create(null);this.renderConstructorParam={};this.constructorFn=null;this.constructorOption={}};b.prototype.setProps=function(a){for(var d in a)k.call(this,d)&&(this[d]=a[d])};b.prototype.validator=function(a){void 0==a&&this.throwError("syntax",'"option" is required ');void 0==a.url&&this.throwError("syntax",'option\'s prop is required: "url"');return!0};b.prototype.setConstructor=function(a){var d=this,e;a.some(function(b,
c){e=l.parseFromString(b,"application/xml").childNodes[0];if(e.hasAttribute("dialog-type")&&"constructor"===e.getAttribute("dialog-type"))return d.constructorFn=d.makeFn(b.replace(h,"")),a.splice(c,1),!0})};b.prototype.create=function(a){this.validator(a);this.setProps({isDestroy:!1,url:a.url,callee:{create:this.create.bind(this),render:this.render.bind(this),clear:this.clear.bind(this),postMessage:this.postMessage.bind(this),destroy:this.destroy.bind(this)},constructorOption:a.option?this.copyObject(a.option):
{}});var d=this;c.then("create",function(a){d.getDialog(d.url,function(b){var e=b.replace(g,"");b=b.match(g);d.setConstructor(b);b=b.map(function(a,b){return d.makeFn(a.replace(h,""))});d.setProps({html:e,scriptFns:b});a()})});c.then("runConstructor",function(a){this.constructorFn?this.constructorFn(null,null,this.dialogConstructor.bind(this,a)):a()}.bind(this));return this.callee};b.prototype.dialogConstructor=function(a,b){b(this.setStateToScope.bind(this,a),this.constructorOption)};b.prototype.render=
function(a,b){if(!this.isDestroy){var d=this;c.then("render",function(e){-1===d.ids.indexOf(a)&&d.ids.push(a);b&&(d.renderConstructorParam=b);d.renderHTML(a);d.setSelfToScope(a);d.runScript();e()});return this.callee}};b.prototype.clear=function(a){if(!this.isDestroy){var b=this;c.then("clear",function(d){var e=a?[a]:b.ids,c;e.forEach(function(a,b){for(c=document.getElementById(a);c.firstChild;)c.removeChild(c.firstChild)});b.ids=e.filter(function(a,d){return-1===b.ids.indexOf(a)});d()});return this.callee}};
b.prototype.destroy=function(){this.clear();this.initProps();this.isDestroy=!0;return this.callee};b.prototype.renderHTML=function(a){var b=document.getElementById(a);null==b&&this.throwError("error",'not found element: "'+a+'"');b.innerHTML=this.html};b.prototype.runScript=function(){this.scriptFns.forEach(function(a){a(this.message,this.renderConstructorFn.bind(this))}.bind(this))};b.prototype.renderConstructorFn=function(a){a.call(this.scope,this.copyObject(this.renderConstructorParam));this.renderConstructorParam=
null};b.prototype.makeFn=function(a){return Function("message","renderConstructor","dialogConstructor",a)};b.prototype.getDialog=function(a,b){var d=this;if(d.hasCache(a))b(d.getCache(a));else{var c=new XMLHttpRequest;c.open("get",a,!0);c.onload=function(c){200===c.target.status?(d.setCache(a,c.target.response),b(c.target.response)):d.throwError("error",'Invalid url: "'+a+'" ['+c.target.status+"]")};c.send()}};b.prototype.copyObject=function(a){if("string"===typeof a)var b=a;else{b={};for(var c in a)b[c]=
a[c]}return b};b.prototype.setSelfToScope=function(a){a=document.getElementById(a).querySelector("[dialog-root]");this.scope.self=a;this.callee.self=a};b.prototype.setStateToScope=function(a,b){this.scope.state=b;a()};b.prototype.onMessage=function(a,b){this.messageStorage[a]=b};b.prototype.postMessage=function(a,b){if(!this.isDestroy)return c.then("postMessege",function(c){void 0===this.messageStorage[a]&&this.throwError("error","not found onMessage: "+a);this.messageStorage[a].call(this.scope,b);
c()}.bind(this)),this.callee};b.prototype.hasCache=function(a){return k.call(f,a)};b.prototype.setCache=function(a,b){return f[a]=b};b.prototype.getCache=function(a){return f[a]};b.prototype.throwError=function(a,b){var c="[Dialog] "+b;switch(a){case "error":throw Error(c);case "syntac":throw new SyntaxError(c);case "type":throw new TypeError(c);case "range":throw new RangeError(c);}};return b}(function(){var c=function(){this.ing=!1;this.queue=[]};c.prototype.then=function(b,c){this.queue.push(c);
this.run()};c.prototype.run=function(b){!this.ing&&0<this.queue.length&&(this.ing=!0,this.queue.shift()(this.makeResolve(),b))};c.prototype.makeResolve=function(){return function(b){this.ing=!1;this.run(b)}.bind(this)};return new c}()));