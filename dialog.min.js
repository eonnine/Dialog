(function(c){"function"===typeof define&&void 0!==define.amd?define(function(){return c}):this.Dialog=c})(function(c){function a(b){this.initProps();this.create(b);return this.callee}var g=/<script(\s|\S)*?(\s|\S)*?<\/script(\s|\S)*?>/g,h=/<script(\s|\S)*?>|<\/script(\s|\S)*?>/g,k=Object.prototype.hasOwnProperty,l=new DOMParser,f=Object.create(null);a.prototype.initProps=function(){this.isDestroy=!1;this.html=this.url=null;this.scriptFns=[];this.ids=[];this.callee=Object.create(null);this.scope={self:null,
state:{}};this.message={on:this.onMessage.bind(this)};this.messageStorage=Object.create(null);this.renderConstructorParam={};this.constructorFn=null;this.constructorOption={}};a.prototype.setProps=function(b){for(var d in b)k.call(this,d)&&(this[d]=b[d])};a.prototype.validator=function(b){if(void 0==b)throw new SyntaxError('[Dialog] "option" is required ');if(void 0==b.url)throw new SyntaxError('[Dialog] option\'s prop is required: "url" ');return!0};a.prototype.setConstructor=function(b){var d=this,
a;b.some(function(e,c){a=l.parseFromString(e,"application/xml").childNodes[0];if(a.hasAttribute("dialog-type")&&"constructor"===a.getAttribute("dialog-type"))return d.constructorFn=d.makeFn(e.replace(h,"")),b.splice(c,1),!0})};a.prototype.create=function(b){this.validator(b);this.setProps({isDestroy:!1,url:b.url,callee:{create:this.create.bind(this),render:this.render.bind(this),clear:this.clear.bind(this),postMessage:this.postMessage.bind(this),destroy:this.destroy.bind(this)},constructorOption:b.option?
this.copyObject(b.option):{}});var d=this;c.then("create",function(b){d.getDialog(d.url,function(a){var e=a.replace(g,"");a=a.match(g);d.setConstructor(a);a=a.map(function(b,a){return d.makeFn(b.replace(h,""))});d.setProps({html:e,scriptFns:a});b()})});c.then("runConstructor",function(b){this.constructorFn?this.constructorFn(null,null,this.dialogConstructor.bind(this,b)):b()}.bind(this))};a.prototype.dialogConstructor=function(b,a){a(this.setStateToScope.bind(this,b),this.constructorOption)};a.prototype.render=
function(b,a){if(!this.isDestroy){var d=this;c.then("render",function(c){-1===d.ids.indexOf(b)&&d.ids.push(b);a&&(d.renderConstructorParam=a);d.renderHTML(b);d.setSelfToScope(b);d.runScript();c()});return this.callee}};a.prototype.clear=function(b){if(!this.isDestroy){var a=this;c.then("clear",function(d){var c=b?[b]:a.ids,e;c.forEach(function(b,a){for(e=document.getElementById(b);e.firstChild;)e.removeChild(e.firstChild)});a.ids=c.filter(function(b,d){return-1===a.ids.indexOf(b)});d()})}};a.prototype.destroy=
function(){this.clear();this.initProps();this.isDestroy=!0};a.prototype.renderHTML=function(b){var a=document.getElementById(b);if(null==a)throw Error('not found element: "'+b+'"');a.innerHTML=this.html};a.prototype.runScript=function(){this.scriptFns.forEach(function(b){b(this.message,this.renderConstructorFn.bind(this))}.bind(this))};a.prototype.renderConstructorFn=function(b){b.call(this.scope,this.copyObject(this.renderConstructorParam));this.renderConstructorParam=null};a.prototype.makeFn=function(b){return Function("message",
"renderConstructor","dialogConstructor",b)};a.prototype.getDialog=function(b,a){var d=this;if(d.hasCache(b))a(d.getCache(b));else{var c=new XMLHttpRequest;c.open("get",b,!0);c.onload=function(c){d.setCache(b,c.target.response);a(c.target.response)};c.send()}};a.prototype.copyObject=function(b){var a={},c;for(c in b)a[c]=b[c];return a};a.prototype.setSelfToScope=function(b){this.scope.self=document.getElementById(b).querySelector("[dialog-root]")};a.prototype.setStateToScope=function(b,a){this.scope.state=
a;b()};a.prototype.onMessage=function(b,a){this.messageStorage[b]=a};a.prototype.postMessage=function(b,a){this.isDestroy||this.messageStorage[b].call(this.scope,a)};a.prototype.hasCache=function(b){return k.call(f,b)};a.prototype.setCache=function(b,a){return f[b]=a};a.prototype.getCache=function(a){return f[a]};return a}(function(){var c=function(){this.ing=!1;this.queue=[]};c.prototype.then=function(a,c){this.queue.push(c);this.run()};c.prototype.run=function(a){!this.ing&&0<this.queue.length&&
(this.ing=!0,this.queue.shift()(this.makeResolve(),a))};c.prototype.makeResolve=function(){return function(a){this.ing=!1;this.run(a)}.bind(this)};return new c}()));